"use strict";(self.webpackChunkblog=self.webpackChunkblog||[]).push([[8398],{3905:(e,t,n)=>{n.d(t,{Zo:()=>d,kt:()=>k});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function l(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?l(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},l=Object.keys(e);for(a=0;a<l.length;a++)n=l[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(a=0;a<l.length;a++)n=l[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=a.createContext({}),p=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},d=function(e){var t=p(e.components);return a.createElement(s.Provider,{value:t},e.children)},m="mdxType",u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},c=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,l=e.originalType,s=e.parentName,d=i(e,["components","mdxType","originalType","parentName"]),m=p(n),c=r,k=m["".concat(s,".").concat(c)]||m[c]||u[c]||l;return n?a.createElement(k,o(o({ref:t},d),{},{components:n})):a.createElement(k,o({ref:t},d))}));function k(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var l=n.length,o=new Array(l);o[0]=c;var i={};for(var s in t)hasOwnProperty.call(t,s)&&(i[s]=t[s]);i.originalType=e,i[m]="string"==typeof e?e:r,o[1]=i;for(var p=2;p<l;p++)o[p]=n[p];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}c.displayName="MDXCreateElement"},1185:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>o,default:()=>m,frontMatter:()=>l,metadata:()=>i,toc:()=>p});var a=n(7462),r=(n(7294),n(3905));const l={sidebar_position:4},o="NestJS-\u7ee7\u7eed\u7f16\u7801",i={unversionedId:"Nestjs/\u7ee7\u7eed\u7f16\u7801",id:"Nestjs/\u7ee7\u7eed\u7f16\u7801",title:"NestJS-\u7ee7\u7eed\u7f16\u7801",description:"\u8fd9\u4e9b\u96c6\u6210\u65b9\u6848\u4f1a\u7ee7\u7eed\u5728\u5f00\u59cb\u7f16\u7801\u7684\u4ee3\u7801\u4e2d\u7ee7\u7eed\u7f16\u5199\u3002",source:"@site/docs/11-Nestjs/04-\u7ee7\u7eed\u7f16\u7801.md",sourceDirName:"11-Nestjs",slug:"/Nestjs/\u7ee7\u7eed\u7f16\u7801",permalink:"/docs/Nestjs/\u7ee7\u7eed\u7f16\u7801",draft:!1,tags:[],version:"current",sidebarPosition:4,frontMatter:{sidebar_position:4},sidebar:"tutorialSidebar",previous:{title:"NestJS-\u5f00\u59cb\u7f16\u7801",permalink:"/docs/Nestjs/\u5f00\u59cb\u7f16\u7801"},next:{title:"NestJS-\u4e00\u4e9b\u8865\u5145",permalink:"/docs/Nestjs/\u4e00\u4e9b\u8865\u5145"}},s={},p=[{value:"Mysql",id:"mysql",level:2},{value:"\u5b89\u88c5",id:"\u5b89\u88c5",level:3},{value:"\u914d\u7f6e\u4e0e\u51c6\u5907",id:"\u914d\u7f6e\u4e0e\u51c6\u5907",level:3},{value:"\u7f16\u7801",id:"\u7f16\u7801",level:3},{value:"\u4efb\u52a1\u8c03\u5ea6",id:"\u4efb\u52a1\u8c03\u5ea6",level:2},{value:"\u5b89\u88c5",id:"\u5b89\u88c5-1",level:3},{value:"\u6fc0\u6d3b",id:"\u6fc0\u6d3b",level:3},{value:"\u5b9a\u4e49\u4efb\u52a1",id:"\u5b9a\u4e49\u4efb\u52a1",level:3},{value:"\u6587\u4ef6\u4e0a\u4f20\u4e0e\u4e0b\u8f7d",id:"\u6587\u4ef6\u4e0a\u4f20\u4e0e\u4e0b\u8f7d",level:2},{value:"\u4e0a\u4f20",id:"\u4e0a\u4f20",level:3},{value:"\u5b89\u88c5",id:"\u5b89\u88c5-2",level:4},{value:"\u7b80\u5355\u4f7f\u7528",id:"\u7b80\u5355\u4f7f\u7528",level:4},{value:"\u6587\u4ef6\u9a8c\u8bc1",id:"\u6587\u4ef6\u9a8c\u8bc1",level:4},{value:"\u6570\u7ec4\u6587\u4ef6",id:"\u6570\u7ec4\u6587\u4ef6",level:4},{value:"\u591a\u6587\u4ef6\u4e0a\u4f20",id:"\u591a\u6587\u4ef6\u4e0a\u4f20",level:4},{value:"\u4e0d\u6307\u5b9a\u6587\u4ef6\u540d",id:"\u4e0d\u6307\u5b9a\u6587\u4ef6\u540d",level:4},{value:"\u914d\u7f6e\u6587\u4ef6\u5b58\u653e\u76ee\u5f55",id:"\u914d\u7f6e\u6587\u4ef6\u5b58\u653e\u76ee\u5f55",level:4},{value:"\u4e0b\u8f7d\u6587\u4ef6",id:"\u4e0b\u8f7d\u6587\u4ef6",level:3},{value:"Cookie\u548cSession",id:"cookie\u548csession",level:2},{value:"Cookie",id:"cookie",level:3},{value:"\u5b89\u88c5",id:"\u5b89\u88c5-3",level:4},{value:"\u542f\u7528",id:"\u542f\u7528",level:4},{value:"\u4f7f\u7528cookie",id:"\u4f7f\u7528cookie",level:4},{value:"Sesseion",id:"sesseion",level:3},{value:"\u5b89\u88c5",id:"\u5b89\u88c5-4",level:4},{value:"\u542f\u7528",id:"\u542f\u7528-1",level:4},{value:"\u4f7f\u7528",id:"\u4f7f\u7528",level:4},{value:"\u8f93\u5165\u9a8c\u8bc1",id:"\u8f93\u5165\u9a8c\u8bc1",level:2},{value:"\u5b89\u88c5\u4f9d\u8d56",id:"\u5b89\u88c5\u4f9d\u8d56",level:3},{value:"\u914d\u7f6e\u4e0e\u4f7f\u7528",id:"\u914d\u7f6e\u4e0e\u4f7f\u7528",level:3},{value:"Json Web Token",id:"json-web-token",level:2},{value:"\u5b89\u88c5\u4f9d\u8d56",id:"\u5b89\u88c5\u4f9d\u8d56-1",level:3},{value:"\u7f16\u5199Guard\u4ee3\u7801",id:"\u7f16\u5199guard\u4ee3\u7801",level:3},{value:"\u5e94\u7528Guard",id:"\u5e94\u7528guard",level:3},{value:"\u914d\u7f6e\u8def\u7531",id:"\u914d\u7f6e\u8def\u7531",level:3},{value:"\u65e5\u5fd7",id:"\u65e5\u5fd7",level:2},{value:"\u57fa\u672c\u914d\u7f6e",id:"\u57fa\u672c\u914d\u7f6e",level:2},{value:"\u81ea\u5b9a\u4e49\u65e5\u5fd7",id:"\u81ea\u5b9a\u4e49\u65e5\u5fd7",level:3},{value:"\u4f7f\u7528winston",id:"\u4f7f\u7528winston",level:3},{value:"\u5b89\u88c5\u4f9d\u8d56",id:"\u5b89\u88c5\u4f9d\u8d56-2",level:4},{value:"\u914d\u7f6e",id:"\u914d\u7f6e",level:4},{value:"\u66ff\u6362Nest\u9ed8\u8ba4\u7684\u65e5\u5fd7",id:"\u66ff\u6362nest\u9ed8\u8ba4\u7684\u65e5\u5fd7",level:4},{value:"\u5728\u9700\u8981\u7684\u6ce8\u5165\u4f7f\u7528",id:"\u5728\u9700\u8981\u7684\u6ce8\u5165\u4f7f\u7528",level:4},{value:"\u4f7f\u7528\u6587\u4ef6\u5b58\u653e\u65e5\u5fd7",id:"\u4f7f\u7528\u6587\u4ef6\u5b58\u653e\u65e5\u5fd7",level:4},{value:"\u6e90\u4ee3\u7801",id:"\u6e90\u4ee3\u7801",level:4}],d={toc:p};function m(e){let{components:t,...n}=e;return(0,r.kt)("wrapper",(0,a.Z)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"nestjs-\u7ee7\u7eed\u7f16\u7801"},"NestJS-\u7ee7\u7eed\u7f16\u7801"),(0,r.kt)("p",null,"\u8fd9\u4e9b\u96c6\u6210\u65b9\u6848\u4f1a\u7ee7\u7eed\u5728",(0,r.kt)("a",{parentName:"p",href:"/docs/Nestjs/%E5%BC%80%E5%A7%8B%E7%BC%96%E7%A0%81"},(0,r.kt)("inlineCode",{parentName:"a"},"\u5f00\u59cb\u7f16\u7801")),"\u7684\u4ee3\u7801\u4e2d\u7ee7\u7eed\u7f16\u5199\u3002"),(0,r.kt)("h2",{id:"mysql"},"Mysql"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"NestJS"),"\u63a8\u8350\u4f7f\u7528",(0,r.kt)("inlineCode",{parentName:"p"},"@nestjs/typeorm typeorm mysql2"),"\u7684\u65b9\u6848\u6765\u63a5\u5165",(0,r.kt)("inlineCode",{parentName:"p"},"mysql"),"\u3002"),(0,r.kt)("h3",{id:"\u5b89\u88c5"},"\u5b89\u88c5"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"yarn add @nestjs/typeorm typeorm mysql2\n")),(0,r.kt)("h3",{id:"\u914d\u7f6e\u4e0e\u51c6\u5907"},"\u914d\u7f6e\u4e0e\u51c6\u5907"),(0,r.kt)("p",null,"\u8fd9\u91cc\u4f1a\u5c06",(0,r.kt)("inlineCode",{parentName:"p"},"Mysql"),"\u5bf9\u5e94\u7684\u4ee3\u7801\u5168\u90e8\u653e\u5728\u4e00\u4e2a\u65b0\u7684\u6a21\u5757\u4e2d"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ nest g res mysql\n")),(0,r.kt)("p",null,"\u547d\u4ee4\u8fd0\u884c\u5b8c\u6210\u540e\u4f1a\u5728",(0,r.kt)("inlineCode",{parentName:"p"},"src"),"\u4e0b\u751f\u6210\u4e00\u4e2a",(0,r.kt)("inlineCode",{parentName:"p"},"mysql"),"\u7684\u6587\u4ef6\u5939\uff0c\u5177\u4f53\u7ed3\u6784\u5982\u4e0b\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-text"},"\u251c\u2500mysql.controller.spec.ts\n\u251c\u2500mysql.controller.ts\n\u251c\u2500mysql.module.ts\n\u251c\u2500mysql.service.spec.ts\n\u251c\u2500mysql.service.ts\n\u251c\u2500entities\n| \u2514mysql.entity.ts\n\u251c\u2500dto\n| \u251c\u2500create-mysql.dto.ts\n| \u2514update-mysql.dto.ts\n")),(0,r.kt)("p",null,"\u63a5\u7740\u914d\u7f6e\uff0c\u9996\u5148\u5c06",(0,r.kt)("inlineCode",{parentName:"p"},"mysql"),"\u7684\u8fde\u63a5\u914d\u7f6e\u5199\u5230",(0,r.kt)("inlineCode",{parentName:"p"},".env"),"\u4e2d"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-textile"},'MYSQL_URL="mysql://nest:\u8fd9\u91cc\u662f\u5bc6\u7801@localhost:3306/nest-first?allowPublicKeyRetrieval=true"\n')),(0,r.kt)("h3",{id:"\u7f16\u7801"},"\u7f16\u7801"),(0,r.kt)("p",null,"\u51c6\u5907\u5b9e\u4f53\u7c7b",(0,r.kt)("inlineCode",{parentName:"p"},"src/mysql/entities/user.entity.ts")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Entity, Column, PrimaryGeneratedColumn } from 'typeorm';\n\n@Entity()\nexport class User {\n  @PrimaryGeneratedColumn()\n  id: number;\n\n  @Column()\n  firstName: string;\n\n  @Column()\n  lastName: string;\n\n  @Column({ default: true })\n  isActive: boolean;\n}\n")),(0,r.kt)("p",null,"\u4fee\u6539",(0,r.kt)("inlineCode",{parentName:"p"},"app.module.ts"),"\uff0c\u5728 ",(0,r.kt)("inlineCode",{parentName:"p"},"imports"),"\u4e2d\u52a0\u5165\u5982\u4e0b\u4ee3\u7801"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},'    TypeOrmModule.forRootAsync({\n      inject: [ConfigService],\n      imports: [ConfigModule],\n      useFactory: async (configService: ConfigService) => {\n        return {\n          type: \'mysql\',\n          url: configService.get("MYSQL_URL"),\n          entities: ["dist/**/*.entity{.ts,.js}"],\n          synchronize: true,\n        }\n      }\n    }),\n    MysqlModule,MysqlModule,\n')),(0,r.kt)("p",null,"\u63a5\u7740\u4fee\u6539",(0,r.kt)("inlineCode",{parentName:"p"},"mysql.module.ts")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Module } from '@nestjs/common';\nimport { MysqlService } from './mysql.service';\nimport { MysqlController } from './mysql.controller';\nimport { TypeOrmModule } from '@nestjs/typeorm';\nimport { User } from './entities/user.entity';\n\n@Module({\n  imports: [TypeOrmModule.forFeature([User])],\n  controllers: [MysqlController],\n  providers: [MysqlService]\n})\nexport class MysqlModule {}\n")),(0,r.kt)("p",null,"\u542f\u52a8\u9879\u76ee\u540e\u6570\u636e\u5e93\u4e2d\u5df2\u7ecf\u81ea\u52a8\u521b\u5efa\u597d\u4e86",(0,r.kt)("inlineCode",{parentName:"p"},"user"),"\u8868\uff0c\u7ee7\u7eed\u7f16\u5199\u4f2a\u4e1a\u52a1\u4ee3\u7801"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"// @@filename mysql.service.ts\nimport { Injectable } from '@nestjs/common';\nimport { InjectRepository } from '@nestjs/typeorm';\nimport { Repository } from 'typeorm';\nimport { CreateMysqlDto } from './dto/create-mysql.dto';\nimport { UpdateMysqlDto } from './dto/update-mysql.dto';\nimport { User } from './entities/user.entity';\n\n@Injectable()\nexport class MysqlService {\n  constructor(\n    @InjectRepository(User)\n    private usersRepository: Repository<User>,\n  ) {}\n\n  create(createMysqlDto: CreateMysqlDto) {\n    const user = this.usersRepository.create(createMysqlDto);\n    return this.usersRepository.insert(user);\n  }\n\n  findAll() {\n    return this.usersRepository.find();\n  }\n\n  findOne(id: number) {\n    return this.usersRepository.findOneBy({ id });\n  }\n\n  update(id: number, updateMysqlDto: UpdateMysqlDto) {\n    return this.usersRepository.update(id, updateMysqlDto);\n  }\n\n  remove(id: number) {\n    return this.usersRepository.delete(id);\n  }\n}\n")),(0,r.kt)("p",null,"\u73b0\u5728\u5c31\u53ef\u4ee5\u5728",(0,r.kt)("a",{parentName:"p",href:"http://localhost:3002/api#/default/MysqlController_create"},(0,r.kt)("inlineCode",{parentName:"a"},"http://localhost:3002/api")),"\u4e2d\u6d4b\u8bd5mysql\u4e0b\u7684api\u4e86\uff0c\u5982\u679c\u9700\u8981\u4e86\u89e3\u66f4\u591a\u76f8\u5173\u5185\u5bb9\u53ef\u4ee5\u53c2\u8003",(0,r.kt)("a",{parentName:"p",href:"https://docs.nestjs.com/techniques/database"},"Database | NestJS - A progressive Node.js framework"),"\u3002\u4ee3\u7801\u5730\u5740\uff1a",(0,r.kt)("a",{parentName:"p",href:"https://github.com/ChaoweiLuo/nest-first/commit/57f868841e3f3a736ee40608e32141b09b99a805"},(0,r.kt)("inlineCode",{parentName:"a"},"Github"))),(0,r.kt)("h2",{id:"\u4efb\u52a1\u8c03\u5ea6"},"\u4efb\u52a1\u8c03\u5ea6"),(0,r.kt)("p",null,"\u5728\u7279\u5b9a\u65f6\u95f4\u9700\u8981\u505a\u4e00\u4e9b\u7279\u5b9a\u7684\u4e8b\u60c5\u6216\u8005\u6709\u4e00\u4e9b\u5468\u671f\u6027\u7684\u4efb\u52a1\u65f6\u5c31\u9700\u8981\u7528\u5230\u4efb\u52a1\u8c03\u5ea6\uff0c\u5728",(0,r.kt)("inlineCode",{parentName:"p"},"NestJS"),"\u4e2d\u6709\u6210\u719f\u7684\u65b9\u6848\u6765\u5904\u7406\u5b83\u3002\u5728",(0,r.kt)("inlineCode",{parentName:"p"},"NestJS"),"\u4e2d\u4efb\u52a1\u8c03\u5ea6\u5141\u8bb8\u60a8\u8c03\u5ea6\u4efb\u610f\u4ee3\u7801\uff08\u65b9\u6cd5/\u51fd\u6570\uff09\uff0c\u4ee5\u4fbf\u5728\u56fa\u5b9a\u65e5\u671f/\u65f6\u95f4\u3001\u5b9a\u671f\u95f4\u9694\u6216\u6307\u5b9a\u95f4\u9694\u540e\u6267\u884c\u4e00\u6b21\u3002"),(0,r.kt)("h3",{id:"\u5b89\u88c5-1"},"\u5b89\u88c5"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ yarn add @nestjs/schedule\n$ yarn add -D @types/cron\n")),(0,r.kt)("h3",{id:"\u6fc0\u6d3b"},"\u6fc0\u6d3b"),(0,r.kt)("p",null,"\u8981\u6fc0\u6d3b\u4efb\u52a1\u8c03\u5ea6\u9700\u8981\u5728",(0,r.kt)("inlineCode",{parentName:"p"},"app.module"),"\u7684",(0,r.kt)("inlineCode",{parentName:"p"},"imports"),"\u4e2d\u8c03\u7528",(0,r.kt)("inlineCode",{parentName:"p"},"ScheduleModule"),"\u7684",(0,r.kt)("inlineCode",{parentName:"p"},"forRoot"),"\u65b9\u6cd5"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"imports: [ScheduleModule.forRoot()],\n")),(0,r.kt)("h3",{id:"\u5b9a\u4e49\u4efb\u52a1"},"\u5b9a\u4e49\u4efb\u52a1"),(0,r.kt)("p",null,"\u5728",(0,r.kt)("inlineCode",{parentName:"p"},"NestJS"),"\u4e2d\u6211\u4eec\u53ef\u4ee5\u5728\u4efb\u4f55\u4e00\u4e2a",(0,r.kt)("inlineCode",{parentName:"p"},"provider"),"\u4e2d\u5c06\u4e00\u4e2a\u65b9\u6cd5\u5b9a\u4e49\u4e3a",(0,r.kt)("inlineCode",{parentName:"p"},"Job"),"\uff0c\u5206\u522b\u5728",(0,r.kt)("inlineCode",{parentName:"p"},"app.service"),"\u548c",(0,r.kt)("inlineCode",{parentName:"p"},"mysql.service"),"\u4e2d\u52a0\u5165\u4ee3\u7801"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"// @@ src/app.service.ts\n  @Cron(CronExpression.EVERY_5_SECONDS)\n  appJob() {\n    console.log('appJob Running.', new Date());\n  }\n// @@filename src/mysql/mysql.service.ts\n  @Cron(CronExpression.EVERY_10_SECONDS)\n  sqlJob() {\n    console.log('sqlJob Running.', new Date());\n  }\n")),(0,r.kt)("p",null,"\u8fd0\u884c\u9879\u76ee\u540e\u80fd\u5728\u63a7\u5236\u592a\u5468\u671f\u6027\u7684\u770b\u5230\u65e5\u5fd7\u8f93\u51fa\uff0c\u8bf4\u660e\u4efb\u52a1\u5df2\u7ecf\u6b63\u5e38\u8c03\u7528\u3002"),(0,r.kt)("p",null,"\u66f4\u591a\u76f8\u5173\u5185\u5bb9\u8bf7\u53c2\u8003\uff1a",(0,r.kt)("a",{parentName:"p",href:"https://docs.nestjs.com/techniques/task-scheduling"},"Task Scheduling | NestJS - A progressive Node.js framework")),(0,r.kt)("p",null,"\u6e90\u4ee3\u7801\uff1a",(0,r.kt)("a",{parentName:"p",href:"https://github.com/ChaoweiLuo/nest-first/commit/ce8b57e11893e859d256645bc64631a8648a2e6b"},(0,r.kt)("inlineCode",{parentName:"a"},"Github"))," "),(0,r.kt)("h2",{id:"\u6587\u4ef6\u4e0a\u4f20\u4e0e\u4e0b\u8f7d"},"\u6587\u4ef6\u4e0a\u4f20\u4e0e\u4e0b\u8f7d"),(0,r.kt)("h3",{id:"\u4e0a\u4f20"},"\u4e0a\u4f20"),(0,r.kt)("p",null,"\u4e3a\u4e86\u5904\u7406\u6587\u4ef6\u4e0a\u4f20\uff0cNest \u4e3a Express \u63d0\u4f9b\u4e86\u4e00\u4e2a\u57fa\u4e8e ",(0,r.kt)("inlineCode",{parentName:"p"},"multer")," \u4e2d\u95f4\u4ef6\u5305\u7684\u5185\u7f6e\u6a21\u5757\u3002",(0,r.kt)("inlineCode",{parentName:"p"},"Multer")," \u5904\u7406\u4ee5",(0,r.kt)("inlineCode",{parentName:"p"},"multipart/form-data"),"\u683c\u5f0f\u53d1\u5e03\u7684\u6570\u636e\uff0c\u8be5\u683c\u5f0f\u4e3b\u8981\u7528\u4e8e\u901a\u8fc7 ",(0,r.kt)("inlineCode",{parentName:"p"},"HTTP POST"),"\u8bf7\u6c42\u4e0a\u4f20\u6587\u4ef6\u3002\u8be5\u6a21\u5757\u662f\u5b8c\u5168\u53ef\u914d\u7f6e\u7684\uff0c\u60a8\u53ef\u4ee5\u6839\u636e\u60a8\u7684\u5e94\u7528\u7a0b\u5e8f\u8981\u6c42\u505a\u51fa\u76f8\u5e94\u7684\u8c03\u6574\u3002"),(0,r.kt)("h4",{id:"\u5b89\u88c5-2"},"\u5b89\u88c5"),(0,r.kt)("p",null,"\u4e3a\u4e86\u66f4\u597d\u7684\u4f7f\u7528",(0,r.kt)("inlineCode",{parentName:"p"},"multer"),"\u5148\u5b89\u88c5\u7c7b\u578b\u6a21\u5757",(0,r.kt)("inlineCode",{parentName:"p"},"@types/multer"),"\uff0c\u5b89\u88c5\u5b8c\u4e4b\u540e\u5c31\u53ef\u4ee5\u4f7f\u7528",(0,r.kt)("inlineCode",{parentName:"p"},"Express.Multer.File")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ yarn add -D @types/multer\n")),(0,r.kt)("h4",{id:"\u7b80\u5355\u4f7f\u7528"},"\u7b80\u5355\u4f7f\u7528"),(0,r.kt)("p",null," Nest\u4f7f\u7528",(0,r.kt)("inlineCode",{parentName:"p"},"\u62e6\u622a\u5668\uff08Interceptor\uff09"),"\u5148\u5c06\u4e0a\u4f20\u7684\u6587\u4ef6\u5904\u7406\u597d\u518d\u4ea4\u7ed9\u63a7\u5236\u5668\u6765\u5904\u7406\uff0c\u6240\u4ee5\u9700\u8981\u5728\u5bf9\u5e94\u7684\u8def\u7531\u4e0a\u52a0\u4e0a",(0,r.kt)("inlineCode",{parentName:"p"},"FileInterceptor"),"\u62e6\u622a\u5668"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"@Post('upload')\n@UseInterceptors(FileInterceptor('file'))\nuploadFile(@UploadedFile() file: Express.Multer.File) {\n  console.log(file);\n}\n")),(0,r.kt)("h4",{id:"\u6587\u4ef6\u9a8c\u8bc1"},"\u6587\u4ef6\u9a8c\u8bc1"),(0,r.kt)("p",null,"\u5728\u4e00\u4e9b\u573a\u666f\u4e0b\u6211\u4eec\u9700\u8981\u9a8c\u8bc1\u6587\u4ef6\u7684\u5927\u5c0f\u6216\u8005\u683c\u5f0f\uff08\u6bd4\u5982\uff1a\u7528\u6237\u4e0a\u4f20\u5934\u50cf\uff09\u3002\u6b64\u65f6\u6211\u4eec\u53ef\u4ee5\u5728",(0,r.kt)("inlineCode",{parentName:"p"},"UploadFile()"),"\u88c5\u9970\u5668\u8c03\u7528\u7684\u65b9\u6cd5\u4e2d\u4f20\u5165",(0,r.kt)("inlineCode",{parentName:"p"},"ParseFilePipe"),"\u5e76\u5728\u6784\u9020\u65f6\u4f20\u5165\u5177\u4f53\u7684\u9a8c\u8bc1"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"  @Post('upload')\n  @UseInterceptors(FileInterceptor('file'))\n  uploadFile(\n    @UploadedFile(\n      new ParseFilePipe({\n        validators: [\n          new MaxFileSizeValidator({ maxSize: 1000 }),\n          new FileTypeValidator({ fileType: 'image/jpeg' }),\n        ],\n      }),\n    )\n    file: Express.Multer.File,\n  ) {\n    console.log('file', file);\n  }\n")),(0,r.kt)("h4",{id:"\u6570\u7ec4\u6587\u4ef6"},"\u6570\u7ec4\u6587\u4ef6"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"  @Post('uploadarray')\n  @UseInterceptors(FilesInterceptor('files'))\n  uploadFileArray(@UploadedFiles() files: Array<Express.Multer.File>) {\n    console.log(files);\n  } \n")),(0,r.kt)("h4",{id:"\u591a\u6587\u4ef6\u4e0a\u4f20"},"\u591a\u6587\u4ef6\u4e0a\u4f20"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"  @Post('uploads')\n  @UseInterceptors(\n    FileFieldsInterceptor([\n      { name: 'avatar', maxCount: 1 },\n      { name: 'file', maxCount: 1 },\n    ]),\n  )\n  uploadFiles(\n    @UploadedFiles()\n    files: {\n      avatar?: Express.Multer.File[];\n      file?: Express.Multer.File[];\n    },\n  ) {\n    console.log(files);\n  }\n")),(0,r.kt)("h4",{id:"\u4e0d\u6307\u5b9a\u6587\u4ef6\u540d"},"\u4e0d\u6307\u5b9a\u6587\u4ef6\u540d"),(0,r.kt)("p",null,"Nest\u63d0\u4f9b\u4e86",(0,r.kt)("inlineCode",{parentName:"p"},"AnyFilesInterceptor"),"\u62e6\u622a\u5668\u6765\u89e3\u6790\u6240\u6709\u7684\u6587\u4ef6"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"@Post('uploadany')\n@UseInterceptors(AnyFilesInterceptor())\nuploadFile(@UploadedFiles() files: Array<Express.Multer.File>) {\n  console.log(files);\n}\n")),(0,r.kt)("h4",{id:"\u914d\u7f6e\u6587\u4ef6\u5b58\u653e\u76ee\u5f55"},"\u914d\u7f6e\u6587\u4ef6\u5b58\u653e\u76ee\u5f55"),(0,r.kt)("p",null,"\u5148\u5c06\u5b58\u653e\u76ee\u5f55\u914d\u7f6e\u5230",(0,r.kt)("inlineCode",{parentName:"p"},".env"),"\u4e2d"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-textile"},'FILE_DEST="/codes/upload"\n')),(0,r.kt)("p",null,"\u4fee\u6539",(0,r.kt)("inlineCode",{parentName:"p"},"app.module"),"\uff0c\u5bfc\u5165\u6a21\u5757"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},'    MulterModule.registerAsync({\n      inject: [ConfigService],\n      imports: [ConfigModule],\n      useFactory: async (configService: ConfigService) => ({\n        dest: configService.get("FILE_DEST")\n      }),\n    }),\n')),(0,r.kt)("h3",{id:"\u4e0b\u8f7d\u6587\u4ef6"},"\u4e0b\u8f7d\u6587\u4ef6"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"\u5b8c\u5168\u8bfb\u53d6\u6587\u4ef6\u5185\u5bb9\u518d\u8fd4\u56de")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},'  @Get("download")\n  @Header("content-type", "html/text")\n  async download() {\n    const content = await readFile(__filename);\n    return content.toString();\n  }\n')),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"\u4f7f\u7528\u6d41\u5f0f\u4e0b\u8f7d")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},'  @Get("pipe")\n  @Header("content-type", "html/text")\n  pipe(@Res() res: Response) {\n    const reader = createReadStream(__filename);\n    reader.pipe(res);\n  }\n')),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"\u4e00\u4e9b\u5934")),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},'Content-Disposition: attachment; filename="app.ts" ')," \u544a\u8bc9\u6d4f\u89c8\u5668\u6309\u9644\u4ef6\u7684\u65b9\u5f0f\u53bb\u4e0b\u8f7d"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},'"content-type:html/text')," \u6307\u5b9a\u6587\u4ef6\u683c\u5f0f"),(0,r.kt)("h2",{id:"cookie\u548csession"},"Cookie\u548cSession"),(0,r.kt)("p",null,"\u867d\u7136\u73b0\u5728\u5df2\u7ecf\u57fa\u672c\u4e0a\u4e0d\u7528\u8fd9\u4fe9\uff0c\u4f46\u4ecd\u7136\u53ef\u4ee5\u4e86\u89e3\u4e00\u4e0b"),(0,r.kt)("h3",{id:"cookie"},"Cookie"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"HTTP cookie"),"\u662f\u7528\u6237\u6d4f\u89c8\u5668\u5b58\u50a8\u7684\u4e00\u5c0f\u5757\u6570\u636e\u3002",(0,r.kt)("inlineCode",{parentName:"p"},"Cookie"),"\u88ab\u8bbe\u8ba1\u4e3a\u7f51\u7ad9\u8bb0\u4f4f\u6709\u72b6\u6001\u4fe1\u606f\u7684\u53ef\u9760\u673a\u5236\u3002\u5f53\u7528\u6237\u518d\u6b21\u8bbf\u95ee\u7f51\u7ad9\u65f6\uff0c",(0,r.kt)("inlineCode",{parentName:"p"},"Cookie"),"\u5c06\u968f\u8bf7\u6c42\u81ea\u52a8\u53d1\u9001\u3002"),(0,r.kt)("h4",{id:"\u5b89\u88c5-3"},"\u5b89\u88c5"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ yarn add cookie-parser\n$ yarn add -D @types/cookie-parser\n")),(0,r.kt)("h4",{id:"\u542f\u7528"},"\u542f\u7528"),(0,r.kt)("p",null,"\u4fee\u6539",(0,r.kt)("inlineCode",{parentName:"p"},"app.module.ts"),"\u4e2d\u7684bootstrap\u65b9\u6cd5"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"import * as cookieParser from 'cookie-parser'; // \u6587\u4ef6\n\n// bootstrap\u65b9\u6cd5\u4e2d\napp.use(cookieParser()); // \n")),(0,r.kt)("h4",{id:"\u4f7f\u7528cookie"},"\u4f7f\u7528cookie"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"  @Get(\"cookie\")\n  getCookie(@Req() req: Request) {\n    return req.cookies;\n  }\n\n  @Post(\"cookie\")\n  setCookie(\n    @Body('key') key: string,\n    @Body('value') value: string,\n    @Res() res: Response,\n  ) {\n    res.cookie(key, value);\n  };\n}\n")),(0,r.kt)("p",null,"\u66f4\u591a",(0,r.kt)("inlineCode",{parentName:"p"},"cookie"),"\u64cd\u4f5c\u8bf7\u67e5\u770b\uff1a",(0,r.kt)("a",{parentName:"p",href:"https://github.com/expressjs/cookie-parser#readme"},"expressjs/cookie-parser: Parse HTTP request cookies (github.com)")),(0,r.kt)("h3",{id:"sesseion"},"Sesseion"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"Session"),"\u63d0\u4f9b\u4e86\u4e00\u79cd\u8de8\u591a\u4e2a\u8bf7\u6c42\u5b58\u50a8\u7528\u6237\u4fe1\u606f\u7684\u65b9\u6cd5\uff0c\u53ef\u4ee5\u4e3a\u7528\u6237\u4fdd\u5b58\u4e00\u4e9b\u72b6\u6001"),(0,r.kt)("h4",{id:"\u5b89\u88c5-4"},"\u5b89\u88c5"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ yarn add express-session\n$ yarn add -D @types/express-session\n")),(0,r.kt)("h4",{id:"\u542f\u7528-1"},"\u542f\u7528"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"// @@filename main.ts\nimport * as session from 'express-session';\n\n// bootstrap method\napp.use(\n  session({\n    secret: configService.get(\"SESSION_SECRET\", 'nest-first'),\n    resave: false,\n    saveUninitialized: false,\n  }),\n);\n")),(0,r.kt)("h4",{id:"\u4f7f\u7528"},"\u4f7f\u7528"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"  @Get('session')\n  findAll(@Session() session: Record<string, any>) {\n    session.visits = session.visits ? session.visits + 1 : 1;\n    return session;\n  }\n")),(0,r.kt)("p",null,"\u66f4\u591a",(0,r.kt)("inlineCode",{parentName:"p"},"Session"),"\u76f8\u5173\u7684\u8bf7\u53c2\u8003",(0,r.kt)("a",{parentName:"p",href:"https://github.com/expressjs/session#readme"},"expressjs/session: Simple session middleware for Express (github.com)")),(0,r.kt)("p",null,"\u9879\u76ee\u6e90\u7801\uff1a",(0,r.kt)("a",{parentName:"p",href:"https://github.com/ChaoweiLuo/nest-first/commit/757ae63ca9259785825171ab04a91345ccad5e38"},(0,r.kt)("inlineCode",{parentName:"a"},"Github"))),(0,r.kt)("h2",{id:"\u8f93\u5165\u9a8c\u8bc1"},"\u8f93\u5165\u9a8c\u8bc1"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"Nest"),"\u4e2d\u53ef\u4ee5\u4f7f\u7528",(0,r.kt)("inlineCode",{parentName:"p"},"\u7ba1\u9053"),"\u6765\u5904\u7406\u8f93\u5165\u6709\u6548\u6027\u7684\u9a8c\u8bc1\uff0c\u5728",(0,r.kt)("inlineCode",{parentName:"p"},"Nest"),"\u4e2d\u5185\u7f6e\u4e86\u4e00\u4e9b\u7ba1\u9053\u6765\u5904\u7406\u8f93\u5165\u7684\u9a8c\u8bc1\u4e0e\u683c\u5f0f\u8f6c\u5316"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"ValidationPipe")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"ParseIntPipe")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"ParseBoolPipe")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"ParseArrayPipe")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"ParseUUIDPipe"))),(0,r.kt)("h3",{id:"\u5b89\u88c5\u4f9d\u8d56"},"\u5b89\u88c5\u4f9d\u8d56"),(0,r.kt)("p",null,"\u8981\u4f7f\u7528\u5185\u7f6e\u7684\u9a8c\u8bc1\u7ba1\u9053\uff0c\u9700\u8981\u5148\u5b89\u88c5\u5fc5\u8981\u7684",(0,r.kt)("inlineCode",{parentName:"p"},"\u4f9d\u8d56")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ yarn add class-validator class-transformer\n")),(0,r.kt)("h3",{id:"\u914d\u7f6e\u4e0e\u4f7f\u7528"},"\u914d\u7f6e\u4e0e\u4f7f\u7528"),(0,r.kt)("p",null,"1\u3001\u5b9a\u4e49DTO"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},'// @@filename src/mysql/dto/create-mysql.dto.ts\nimport { IsBoolean, IsString } from "class-validator"\nimport { IsNotEmpty } from "class-validator/types/decorator/decorators"\n\nexport class CreateMysqlDto {\n\n  @IsString()\n  @IsNotEmpty()\n  firstName: string\n\n  @IsString()\n  @IsNotEmpty()\n  lastName: string\n\n  @IsBoolean()\n  isActive?: boolean\n}\n')),(0,r.kt)("p",null,"2\u3001\u4f7f\u7528"),(0,r.kt)("p",null,"\u4f7f\u7528\u7ba1\u9053\u9a8c\u8bc1\u4e00\u822c\u6709\u4e24\u79cd\u65b9\u6cd5\u3002\u5176\u4e2d\u4e00\u79cd\u662f\u5168\u5c40\u9a8c\u8bc1"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"// \u4fee\u6539 main.ts \napp.useGlobalPipes(new ValidationPipe());\n")),(0,r.kt)("p",null,"\u53e6\u4e00\u79cd\u662f\u5728\u8def\u7531\u4e0a\u52a0\u4e0a\u7279\u5b9a\u6ce8\u89e3"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"@UsePipes(new ValidationPipe({ transform: true }))\n")),(0,r.kt)("p",null,"3\u3001\u4e00\u4e9b\u914d\u7f6e\u53c2\u6570"),(0,r.kt)("p",null,"Nest\u4e2d\u5185\u7f6e\u4e86\u4e09\u4e2a\u53ef\u9009\u5c5e\u6027\uff08",(0,r.kt)("inlineCode",{parentName:"p"},"transform"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"disableErrorMessages"),", `",(0,r.kt)("inlineCode",{parentName:"p"},"exceptionFactory"),"\uff09\uff0c\u4f46\u662f",(0,r.kt)("inlineCode",{parentName:"p"},"class-validator"),"\u5b9e\u9645\u4e0a\u6709\u66f4\u591a\u7684\u5c5e\u6027"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"\u5c5e\u6027"),(0,r.kt)("th",{parentName:"tr",align:null},"\u7c7b\u578b"),(0,r.kt)("th",{parentName:"tr",align:null},"\u63cf\u8ff0"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"enableDebugMessages")),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"boolean")),(0,r.kt)("td",{parentName:"tr",align:null},"\u5982\u679c\u8bbe\u7f6e\u4e3atrue\uff0c\u9a8c\u8bc1\u5668\u5c06\u5728\u51fa\u73b0\u9519\u8bef\u65f6\u5411\u63a7\u5236\u53f0\u6253\u5370\u989d\u5916\u7684\u8b66\u544a\u6d88\u606f\u3002")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"skipUndefinedProperties")),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"boolean")),(0,r.kt)("td",{parentName:"tr",align:null},"\u5982\u679c\u8bbe\u7f6e\u4e3atrue\uff0c\u90a3\u4e48\u9a8c\u8bc1\u5668\u5c06\u8df3\u8fc7\u9a8c\u8bc1\u5bf9\u8c61\u4e2d\u672a\u5b9a\u4e49\u7684\u6240\u6709\u5c5e\u6027\u7684\u9a8c\u8bc1\u3002")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"skipNullProperties")),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"boolean")),(0,r.kt)("td",{parentName:"tr",align:null},"\u5982\u679c\u8bbe\u7f6e\u4e3atrue\uff0c\u90a3\u4e48\u9a8c\u8bc1\u5668\u5c06\u8df3\u8fc7\u9a8c\u8bc1\u5bf9\u8c61\u4e2d\u4e3a\u7a7a\u7684\u6240\u6709\u5c5e\u6027\u7684\u9a8c\u8bc1\u3002")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"skipMissingProperties")),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"boolean")),(0,r.kt)("td",{parentName:"tr",align:null},"\u5982\u679c\u8bbe\u7f6e\u4e3atrue\uff0c\u90a3\u4e48\u9a8c\u8bc1\u5668\u5c06\u8df3\u8fc7\u9a8c\u8bc1\u5bf9\u8c61\u4e2d\u4e3a\u7a7a\u6216\u672a\u5b9a\u4e49\u7684\u6240\u6709\u5c5e\u6027\u7684\u9a8c\u8bc1\u3002")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"whitelist")),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"boolean")),(0,r.kt)("td",{parentName:"tr",align:null},"\u5982\u679c\u8bbe\u7f6e\u4e3atrue\uff0c\u9a8c\u8bc1\u5668\u5c06\u4ece\u672a\u4f7f\u7528\u4efb\u4f55\u9a8c\u8bc1\u4fee\u9970\u7b26\u7684\u4efb\u4f55\u5c5e\u6027\u4e2d\u5265\u79bb\u5df2\u9a8c\u8bc1\uff08\u8fd4\u56de\uff09\u5bf9\u8c61\u3002")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"forbidNonWhitelisted")),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"boolean")),(0,r.kt)("td",{parentName:"tr",align:null},"\u5982\u679c\u8bbe\u7f6e\u4e3atrue\uff0c\u9a8c\u8bc1\u7a0b\u5e8f\u5c06\u629b\u51fa\u5f02\u5e38\uff0c\u800c\u4e0d\u662f\u5265\u79bb\u975e\u767d\u540d\u5355\u7684\u5c5e\u6027\u3002")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"forbidUnknownValues")),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"boolean")),(0,r.kt)("td",{parentName:"tr",align:null},"\u5982\u679c\u8bbe\u7f6e\u4e3atrue\uff0c\u9a8c\u8bc1\u672a\u77e5\u5bf9\u8c61\u7684\u5c1d\u8bd5\u4f1a\u7acb\u5373\u5931\u8d25\u3002")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"disableErrorMessages")),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"boolean")),(0,r.kt)("td",{parentName:"tr",align:null},"\u5982\u679c\u8bbe\u7f6e\u4e3atrue\uff0c\u9a8c\u8bc1\u9519\u8bef\u5c06\u4e0d\u4f1a\u8fd4\u56de\u7ed9\u5ba2\u6237\u7aef\u3002")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"errorHttpStatusCode")),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"number")),(0,r.kt)("td",{parentName:"tr",align:null},"\u6b64\u8bbe\u7f6e\u5141\u8bb8\u60a8\u6307\u5b9a\u5728\u51fa\u73b0\u9519\u8bef\u65f6\u5c06\u4f7f\u7528\u7684\u5f02\u5e38\u7c7b\u578b\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u5b83\u629b\u51fa\u201cBadRequestException\u201d\u3002")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"exceptionFactory")),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"Function")),(0,r.kt)("td",{parentName:"tr",align:null},"\u83b7\u53d6\u9a8c\u8bc1\u9519\u8bef\u7684\u6570\u7ec4\uff0c\u5e76\u8fd4\u56de\u8981\u5f15\u53d1\u7684\u5f02\u5e38\u5bf9\u8c61\u3002")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"groups")),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"string[]")),(0,r.kt)("td",{parentName:"tr",align:null},"\u9a8c\u8bc1\u5bf9\u8c61\u671f\u95f4\u8981\u4f7f\u7528\u7684\u7ec4\u3002")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"always")),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"boolean")),(0,r.kt)("td",{parentName:"tr",align:null},"\u5982\u679c\u8bbe\u7f6e\u4e3atrue\uff0c\u9a8c\u8bc1\u5c06\u4e0d\u4f7f\u7528\u9ed8\u8ba4\u6d88\u606f\u3002\u5982\u679c\u672a\u663e\u5f0f\u8bbe\u7f6e\u9519\u8bef\u6d88\u606f\uff0c\u5219\u9519\u8bef\u6d88\u606f\u59cb\u7ec8\u672a\u5b9a\u4e49\u3002")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"strictGroups")),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"boolean")),(0,r.kt)("td",{parentName:"tr",align:null},"\u5982\u679c\u7ec4\u672a\u7ed9\u5b9a\u6216\u4e3a\u7a7a\uff0c\u8bf7\u5ffd\u7565\u81f3\u5c11\u6709\u4e00\u4e2a\u7ec4\u7684\u4fee\u9970\u7b26\u3002")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"dismissDefaultMessages")),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"boolean")),(0,r.kt)("td",{parentName:"tr",align:null},"\u5982\u679c\u8bbe\u7f6e\u4e3atrue\uff0c\u9a8c\u8bc1\u5c06\u4e0d\u4f7f\u7528\u9ed8\u8ba4\u6d88\u606f\u3002\u5982\u679c\u672a\u663e\u5f0f\u8bbe\u7f6e\u9519\u8bef\u6d88\u606f\uff0c\u5219\u9519\u8bef\u6d88\u606f\u59cb\u7ec8\u672a\u5b9a\u4e49\u3002")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"validationError.target")),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"boolean")),(0,r.kt)("td",{parentName:"tr",align:null},"\u6307\u793a\u662f\u5426\u5e94\u5728\u9a8c\u8bc1\u9519\u8bef\u4e2d\u516c\u5f00\u76ee\u6807\u3002")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"validationError.value")),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"boolean")),(0,r.kt)("td",{parentName:"tr",align:null},"\u6307\u793a\u9a8c\u8bc1\u503c\u662f\u5426\u5e94\u5728\u9a8c\u8bc1\u9519\u8bef\u4e2d\u516c\u5f00\u3002")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"stopAtFirstError")),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"boolean")),(0,r.kt)("td",{parentName:"tr",align:null},"\u5f53\u8bbe\u7f6e\u4e3atrue\u65f6\uff0c\u7ed9\u5b9a\u5c5e\u6027\u7684\u9a8c\u8bc1\u5c06\u5728\u9047\u5230\u7b2c\u4e00\u4e2a\u9519\u8bef\u540e\u505c\u6b62\u3002\u9ed8\u8ba4\u4e3afalse\u3002")))),(0,r.kt)("p",null,"\u60f3\u8981\u4e86\u89e3\u66f4\u591a",(0,r.kt)("inlineCode",{parentName:"p"},"class-validator"),"\u76f8\u5173\u7684\u4fe1\u606f\u53ef\u4ee5\u53c2\u8003\uff1a",(0,r.kt)("a",{parentName:"p",href:"https://github.com/typestack/class-validator"},"typestack/class-validator: Decorator-based property validation for classes. (github.com)")),(0,r.kt)("h2",{id:"json-web-token"},"Json Web Token"),(0,r.kt)("p",null,"\u4e00\u4e2a\u5b8c\u6574\u7684\u9879\u76ee\u600e\u4e48\u80fd\u6ca1\u6709\u4e00\u5957\u8ba4\u8bc1\u548c\u6388\u6743\uff0c\u8fd9\u91cc\u4f7f\u7528",(0,r.kt)("inlineCode",{parentName:"p"},"Json Web Token"),"\u5b8c\u6210\u9879\u76ee\u7684\u8ba4\u8bc1\u548c\u6388\u6743\u3002"),(0,r.kt)("h3",{id:"\u5b89\u88c5\u4f9d\u8d56-1"},"\u5b89\u88c5\u4f9d\u8d56"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ yarn add jsonwebtoken\n$ yarn add -D @types/jsonwebtoken\n")),(0,r.kt)("h3",{id:"\u7f16\u5199guard\u4ee3\u7801"},"\u7f16\u5199Guard\u4ee3\u7801"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"@Injectable()\nexport class AuthenticationGuard implements CanActivate {\n  constructor(private readonly configService: ConfigService) {}\n\n  canActivate(\n    context: ExecutionContext,\n  ): boolean | Promise<boolean> | Observable<boolean> {\n    const request = context.switchToHttp().getRequest<Request>();\n    return this.validateRequest(request);\n  }\n\n  private async validateRequest(request: Request) {\n    const token = request.headers['authorization'];\n    if (token) {\n      const parts = token.split(' ');\n      if (parts.length === 2 || parts[0] === 'Bearer') {\n        //Bearer token \u662f\u6709\u6548\u7684\n        const secret = this.configService.get<string>('JWT_SECRET');\n        try {\n          const data = verify(parts[1], secret) as IUser;\n          request.user = data;\n        } catch {\n\n        }\n      }\n    }\n    return true;\n  }\n\n}\n\n@Injectable()\nexport class AuthorizationGuard implements CanActivate {\n\n  constructor(private readonly reflector: Reflector) {\n  }\n\n  canActivate(context: ExecutionContext): boolean {\n    const request = context.switchToHttp().getRequest<Request>();\n    const roles = this.reflector.get<string[]>('role', context.getHandler());\n    const user: User = (request as any).user;\n    if(roles?.length && !user) throw new UnauthorizedException();\n    if (roles?.length && !roles.includes(user?.role))\n      throw new UnauthorizedException();\n    return true;\n  }\n}\n")),(0,r.kt)("h3",{id:"\u5e94\u7528guard"},"\u5e94\u7528Guard"),(0,r.kt)("p",null,"\u8fd9\u91cc\u5168\u5c40\u4f7f\u7528\u4e86\uff0c\u4e5f\u53ef\u4ee5\u5728\u5177\u4f53\u7684",(0,r.kt)("inlineCode",{parentName:"p"},"Route"),"\u6216\u8005",(0,r.kt)("inlineCode",{parentName:"p"},"Controller"),"\u4e0a\u4f7f\u7528\uff0c\u5177\u4f53\u53c2\u770b",(0,r.kt)("a",{parentName:"p",href:"./%E6%A6%82%E5%BF%B5"},(0,r.kt)("inlineCode",{parentName:"a"},"\u6982\u5ff5"))),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"// main.ts bootstrap\u4e2d\nconst configService = app.get(ConfigService);\nconst reflector = app.get(Reflector);\napp.useGlobalGuards(new AuthenticationGuard(configService));\napp.useGlobalGuards(new AuthorizationGuard(reflector));\n")),(0,r.kt)("h3",{id:"\u914d\u7f6e\u8def\u7531"},"\u914d\u7f6e\u8def\u7531"),(0,r.kt)("p",null,"\u4f7f\u7528",(0,r.kt)("inlineCode",{parentName:"p"},"@SetMetadata('role', ['vip', 'student'])"),"\u6765\u7ed9",(0,r.kt)("inlineCode",{parentName:"p"},"vip"),"\u548c",(0,r.kt)("inlineCode",{parentName:"p"},"student"),"\u6388\u6743"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"import { Body, Controller, Get, Post, SetMetadata, UnauthorizedException } from \"@nestjs/common\";\nimport { hash, LoginDto, users } from \"./user.dto\";\nimport jwt from 'jsonwebtoken';\nimport { ConfigService } from \"@nestjs/config\";\n\n@Controller('auth')\nexport class AuthController {\n\n  constructor(private readonly configService: ConfigService) {}\n\n  @Post(\"login\")\n  login(@Body() { username, password }: LoginDto) {\n    const user = users.find(u => u.username === username);\n    if(!user) throw new UnauthorizedException(\"invaild username.\")\n    if(hash(password) !== user.password) throw new UnauthorizedException(\"invaild password.\");\n    const token = jwt.sign(user, this.configService.get(\"JWT_SECRET\", 'JWT_SECRET'));\n    return {\n      ...user,\n      token,\n    }\n  }\n\n  @Get()\n  all() {\n    return 'all';\n  }\n\n  @SetMetadata('role', ['admin'])\n  @Get(\"admin\")\n  onlyAdmin() {\n    return \"admin\";\n  }\n\n  @SetMetadata('role', ['vip', 'student'])\n  @Get(\"vs\")\n  vipAndStudent() {\n    return 'vip and student.'\n  }\n\n}\n")),(0,r.kt)("p",null,"\u4ee3\u7801\uff1a ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/ChaoweiLuo/nest-first/commit/784c191e185f36f5ee3d28ec594f38b6f18fa7f4"},"nest-first@784c191 \xb7 GitHub")),(0,r.kt)("h2",{id:"\u65e5\u5fd7"},"\u65e5\u5fd7"),(0,r.kt)("p",null,"Nest\u6709\u4e00\u4e2a\u5185\u7f6e\u7684\u57fa\u4e8e\u6587\u672c\u7684\u65e5\u5fd7\u8bb0\u5f55\u5668\uff0c\u5728\u5e94\u7528\u7a0b\u5e8f\u542f\u52a8\u548c\u5176\u4ed6\u4e00\u4e9b\u60c5\u51b5\u4e0b\u4f7f\u7528\uff0c\u5982\u663e\u793a\u6355\u83b7\u7684\u5f02\u5e38\uff08\u5373\u7cfb\u7edf\u65e5\u5fd7\uff09\u3002\u8be5\u529f\u80fd\u662f\u901a\u8fc7@nestjs/common\u5305\u4e2d\u7684Logger\u7c7b\u63d0\u4f9b\u7684\u3002\u9ed8\u8ba4\u7684\u65e5\u5fd7\u8f93\u51fa\u5230\u63a7\u5236\u53f0\u5373",(0,r.kt)("inlineCode",{parentName:"p"},"Console"),"\u3002"),(0,r.kt)("h2",{id:"\u57fa\u672c\u914d\u7f6e"},"\u57fa\u672c\u914d\u7f6e"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"// main.ts\n// \u5173\u95ed\u65e5\u5fd7\nconst app = await NestFactory.create(AppModule, {\n  logger: false,\n});\n\n// \u8bbe\u7f6e\u65e5\u5fd7\u7ea7\u522b\u4e3a `warn` \u548c `error`\nconst app = await NestFactory.create(AppModule, {\n  logger: ['error', 'warn'],\n});\n")),(0,r.kt)("h3",{id:"\u81ea\u5b9a\u4e49\u65e5\u5fd7"},"\u81ea\u5b9a\u4e49\u65e5\u5fd7"),(0,r.kt)("p",null,"\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u5b9e\u73b0",(0,r.kt)("inlineCode",{parentName:"p"},"LoggerService"),"\u4e2d\u7684\u65b9\u6cd5\u6765\u81ea\u5b9a\u4e49\u4e00\u4e2a\u65e5\u5fd7\u8bb0\u5f55\u5668\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"import { LoggerService } from '@nestjs/common';\n\nexport class CustomerLogger implements LoggerService {\n  /**   * Write a 'log' level log.   */\n  log(message: any, ...optionalParams: any[]) {}\n\n  /**   * Write an 'error' level log.   */\n  error(message: any, ...optionalParams: any[]) {}\n\n  /**   * Write a 'warn' level log.   */\n  warn(message: any, ...optionalParams: any[]) {}\n\n  /**   * Write a 'debug' level log.   */\n  debug?(message: any, ...optionalParams: any[]) {}\n\n  /**   * Write a 'verbose' level log.   */\n  verbose?(message: any, ...optionalParams: any[]) {}\n}\n")),(0,r.kt)("h3",{id:"\u4f7f\u7528winston"},"\u4f7f\u7528winston"),(0,r.kt)("p",null,"\u9700\u8981\u4e86\u89e3",(0,r.kt)("inlineCode",{parentName:"p"},"winston"),"\u7684\u53ef\u4ee5\u67e5\u770b\uff1a",(0,r.kt)("a",{parentName:"p",href:"https://github.com/winstonjs/winston"},"GitHub - winstonjs/winston: A logger for just about everything.")),(0,r.kt)("h4",{id:"\u5b89\u88c5\u4f9d\u8d56-2"},"\u5b89\u88c5\u4f9d\u8d56"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ yarn add nest-winston winston\n")),(0,r.kt)("h4",{id:"\u914d\u7f6e"},"\u914d\u7f6e"),(0,r.kt)("p",null,"\u9700\u8981\u5728\u6ce8\u518c",(0,r.kt)("inlineCode",{parentName:"p"},"WindstonModule"),"\u7684\u65f6\u5019\u914d\u7f6e\u597d\u65e5\u5fd7\u7684\u683c\u5f0f\u548c\u6587\u4ef6\u5b58\u50a8\u7684\u4f4d\u7f6e\u7b49\uff0c\u66f4\u591a\u3001\u66f4\u5177\u4f53\u7684\u914d\u7f6e\u9879\u53ef\u4ee5\u81ea\u884c\u53bb\u5b98\u7f51\uff1a",(0,r.kt)("a",{parentName:"p",href:"https://github.com/gremo/nest-winston#readme"},"GitHub - gremo/nest-winston: A Nest module wrapper form winston logger")," \u67e5\u770b"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"// app.module.ts \u5148\u6ce8\u518c\u6a21\u5757\nimports: [ WinstonModule.forRoot({ /** options here */ }) ]\n\n// \u4e5f\u53ef\u4ee5\u4f7f\u7528\u5f02\u6b65\u65b9\u5f0f\nWinstonModule.forRootAsync({\n  // options\n  inject: [ConfigService],\n  imports: [ ConfigModule ],\n  useFactory: (configService: ConfigService) => ({\n    \n  })\n}),\n")),(0,r.kt)("h4",{id:"\u66ff\u6362nest\u9ed8\u8ba4\u7684\u65e5\u5fd7"},"\u66ff\u6362Nest\u9ed8\u8ba4\u7684\u65e5\u5fd7"),(0,r.kt)("p",null,"Nest\u9ed8\u8ba4\u4f7f\u7528",(0,r.kt)("inlineCode",{parentName:"p"},"Console"),"\u8bb0\u5f55\u65e5\u5fd7\uff0c\u4f46\u662f\u5b83\u4e5f\u5141\u8bb8\u6211\u4eec\u624b\u52a8\u66ff\u6362"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"// main.ts\nimport { WINSTON_MODULE_NEST_PROVIDER } from 'nest-winston';\n\napp.useLogger(app.get(WINSTON_MODULE_NEST_PROVIDER));\n")),(0,r.kt)("h4",{id:"\u5728\u9700\u8981\u7684\u6ce8\u5165\u4f7f\u7528"},"\u5728\u9700\u8981\u7684\u6ce8\u5165\u4f7f\u7528"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"import { WINSTON_MODULE_NEST_PROVIDER } from 'nest-winston';\n\n@Controller('log')\nexport class LoggerController {\n  constructor(@Inject(WINSTON_MODULE_NEST_PROVIDER) private readonly logger: LoggerService) { }\n\n  index() {\n    this.logger.warn('log -> index');\n    return \"log\";\n  }\n}\n")),(0,r.kt)("h4",{id:"\u4f7f\u7528\u6587\u4ef6\u5b58\u653e\u65e5\u5fd7"},"\u4f7f\u7528\u6587\u4ef6\u5b58\u653e\u65e5\u5fd7"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"WinstonModule.forRootAsync({\n  // options\n  inject: [ConfigService],\n  imports: [ConfigModule],\n  useFactory: (configService: ConfigService) => ({\n    level: 'info',\n    transports: [\n      // error.log\u4e2d\u53ea\u5b58\u653eerror\u7ea7\u522b\u4ee5\u4e0a\u7684\u65e5\u5fd7\n      new winston.transports.File({\n        filename: 'error.log',\n        level: 'error',\n      }),\n      // \u6240\u6709\u7684\u65e5\u5fd7\u90fd\u4f1a\u8f93\u51fa\u5230\u8fd9\u91cc\n      new winston.transports.Console({\n        format: winston.format.combine(\n          winston.format.timestamp(),\n          winston.format.ms(),\n          utilities.format.nestLike('best-first', {}),\n        ),\n      }),\n    ],\n  }),\n}),\n")),(0,r.kt)("h4",{id:"\u6e90\u4ee3\u7801"},"\u6e90\u4ee3\u7801"),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://github.com/ChaoweiLuo/nest-first/commit/f1acf566b1a4126a7a35cfc83b3cb254f3c392bb"},"https://github.com/ChaoweiLuo/nest-first/commit/f1acf566b1a4126a7a35cfc83b3cb254f3c392bb")))}m.isMDXComponent=!0}}]);